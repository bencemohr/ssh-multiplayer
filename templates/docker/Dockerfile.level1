FROM alpine:latest

# Install SSH server and utilities
RUN apk add --no-cache openssh bash curl

# Create root user with weak password
RUN echo "root:password123" | chpasswd

# SSH Configuration with vulnerabilities
RUN mkdir -p /etc/ssh && \
    ssh-keygen -A

# Create sshd_config with misconfigurations
RUN echo "Port 22" > /etc/ssh/sshd_config && \
    echo "PermitRootLogin yes" >> /etc/ssh/sshd_config && \
    echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config && \
    echo "PubkeyAuthentication no" >> /etc/ssh/sshd_config && \
    echo "PermitEmptyPasswords no" >> /etc/ssh/sshd_config && \
    echo "X11Forwarding yes" >> /etc/ssh/sshd_config && \
    echo "LogLevel DEBUG" >> /etc/ssh/sshd_config && \
    echo "ForceCommand /usr/local/bin/login-logger.sh" >> /etc/ssh/sshd_config && \
    echo "Banner /etc/motd" >> /etc/ssh/sshd_config

# Create MOTD
RUN echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" > /etc/motd && \
    echo "â•‘         LEVEL 1: WEAK CREDENTIALS         â•‘" >> /etc/motd && \
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> /etc/motd && \
    echo "" >> /etc/motd && \
    echo "ðŸŽ‰ LEVEL 1 CAPTURED! ðŸŽ‰" >> /etc/motd && \
    echo "" >> /etc/motd && \
    echo "You successfully logged in with default credentials." >> /etc/motd && \
    echo "FLAG CAPTURED!" >> /etc/motd

# Copy login logger script
COPY templates/docker/login-logger.sh /usr/local/bin/login-logger.sh
RUN chmod +x /usr/local/bin/login-logger.sh

# Create a flag file in root directory
RUN echo "FLAG{ssh_default_credentials_vulnerable}" > /root/flag.txt && \
    chmod 644 /root/flag.txt

# Add container labels
LABEL type=MITS-VICTIM app=mits-multiplayer

# Expose SSH port
EXPOSE 22

# Start SSH server
ENTRYPOINT ["/usr/sbin/sshd", "-D"]
